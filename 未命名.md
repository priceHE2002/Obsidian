```python
import numpy as np
import matplotlib.pyplot as plt
import os

# --- 1. Mac 环境字体配置 (陈教授专用配置) ---
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'Heiti TC', 'sans-serif']
plt.rcParams['axes.unicode_minus'] = False

# --- 2. 信号处理逻辑 ---

# 参数设置
N = 64  # 信号长度
n = np.arange(N)
# 生成一个因果指数衰减信号 x[n] = 0.8^n * u[n]
a = 0.8
x = (a ** n) 

# (1) 路径 A: 直接频域法
# 做 2*N 点 FFT 以避免循环卷积混叠，并获得更高的频谱分辨率
fft_len = 2 * N 
X_k = np.fft.fft(x, fft_len)
# 能量谱 = 幅度的平方
energy_spectrum_direct = (np.abs(X_k)) ** 2

# (2) 路径 B: 自相关法
# 计算自相关 r_x[n] = x[n] * x[-n]
# mode='full' 返回完全卷积结果，长度为 2N-1
r_x = np.correlate(x, x, mode='full') 

# 对自相关序列做 FFT
# 注意：自相关序列 r_x 的零点在中间，但 FFT 默认零点在数组开头。
# 这种相位差异只影响相位谱，不影响幅度（能量）谱，所以直接做 FFT 取模即可验证。
R_x_k = np.fft.fft(r_x, fft_len)
energy_spectrum_autocorr = np.abs(R_x_k) # 理论上 R_x_k 应该是实数（偶对称序列的 DFT），取 abs 消除计算误差

# --- 绘图 ---
freq = np.fft.fftfreq(fft_len, d=1) * 2 * np.pi # 归一化角频率 [-pi, pi]
# 移位以将 0 频率置于中心
freq_shifted = np.fft.fftshift(freq)
es_direct_shifted = np.fft.fftshift(energy_spectrum_direct)
es_autocorr_shifted = np.fft.fftshift(energy_spectrum_autocorr)

fig, ax = plt.subplots(2, 1, figsize=(10, 8))

# 绘制时域信号和自相关
ax[0].stem(np.arange(-(N-1), N), r_x, basefmt=" ", label='自相关序列 $r_x[n]$')
ax[0].set_title('时域：信号的自相关序列')
ax[0].set_xlabel('n')
ax[0].set_ylabel('幅度')
ax[0].grid(True, alpha=0.3)
ax[0].legend()

# 绘制能量谱对比
ax[1].plot(freq_shifted, es_direct_shifted, 'b-', linewidth=3, alpha=0.5, label='直接法 $|X(e^{j\Omega})|^2$')
ax[1].plot(freq_shifted, es_autocorr_shifted, 'r--', linewidth=1.5, label='自相关法 $DTFT\{r_x[n]\}$')
ax[1].set_title('频域：能量谱密度验证')
ax[1].set_xlabel('数字角频率 $\Omega$ (rad)')
ax[1].set_ylabel('能量')
ax[1].set_xlim([-np.pi, np.pi])
ax[1].grid(True, alpha=0.3)
ax[1].legend()

plt.tight_layout()

# --- 3. 自动保存与显示 (固定配置) ---
filename = "自相关与能量谱关系.png" 
vault_path = "/Users/heyuhang/Documents/Obsidian Vault"
full_path = os.path.join(vault_path, filename)

try:
    if os.path.exists(full_path):
        os.remove(full_path) # 覆盖旧图
    plt.savefig(full_path, dpi=300, bbox_inches='tight')
    plt.close() # 释放内存
    print(f"![[{filename}]]") # 触发 Obsidian 显示
except Exception as e:
    print(f"Error: {e}")
```